<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Revisão de Orçamento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Carregar jsPDF usando CDN corretamente -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f7f7f7;
            text-align: center;
            padding: 20px;
        }
        iframe {
            width: 90%;
            height: 800px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
            box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
        }
        .botoes {
            margin-top: 20px;
        }
        .botoes a, .botoes button {
            display: inline-block;
            margin: 10px;
            padding: 12px 20px;
            background-color: #007BFF;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            transition: background-color 0.3s;
            border: none;
            cursor: pointer;
        }
        .botoes a:hover, .botoes button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

    <h2>Revisando Template: {{ template_nome }}</h2>

    <iframe src="{{ iframe_src }}" id="content-to-print" frameborder="0"></iframe>

    <div class="botoes">
        <a href="/verification?template_idx={{ proximo_idx }}">Aprovar e Continuar</a>
        <a href="/postTemplate">Voltar ao Início</a>
        <button id="download-pdf" class="btn btn-primary">Baixar PDF</button>
    </div>

    <script>
    window.addEventListener('load', function() {
    const { jsPDF } = window.jspdf;
    
    document.getElementById('download-pdf').addEventListener('click', async function() {
        const button = this;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Gerando PDF...';
        button.disabled = true;

        try {
            // 1. Extrair conteúdo do iframe
            const iframe = document.getElementById('content-to-print');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            // 2. Criar container temporário com estilos
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.width = '210mm';
            tempDiv.style.background = 'transparent';
            
            // Clonar o conteúdo preservando estilos
            const clone = iframeDoc.documentElement.cloneNode(true);
            clone.style.background = 'transparent';
            tempDiv.appendChild(clone);
            document.body.appendChild(tempDiv);
            
            // 3. Configurações otimizadas do html2canvas
            const options = {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                scrollX: 0,
                scrollY: 0,
                backgroundColor: null, // Fundo transparente
                logging: true,
                onclone: (clonedDoc) => {
                    // Forçar carregamento de recursos
                    clonedDoc.querySelectorAll('img, link[rel="stylesheet"]').forEach(el => {
                        el.crossOrigin = 'Anonymous';
                        if (el.tagName === 'IMG') {
                            el.style.opacity = '1';
                            el.style.visibility = 'visible';
                        }
                    });
                    clonedDoc.body.style.background = 'transparent';
                }
            };
            
            // 4. Adicionar delay para carregar imagens
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 5. Gerar PDF
            const canvas = await html2canvas(tempDiv, options);
            
            // Converter para PNG com fundo transparente
            const imgData = canvas.toDataURL('image/png');
            
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgWidth = 210;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
            pdf.save('orcamento.pdf');
            
        } catch (error) {
            console.error('Erro ao gerar PDF:', error);
            alert('Erro: ' + error.message);
        } finally {
            const tempDiv = document.querySelector('div.temp-pdf-container');
            if (tempDiv) document.body.removeChild(tempDiv);
            
            button.innerHTML = 'Baixar PDF';
            button.disabled = false;
        }
    });
});
    </script>
</body>
</html>