<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
      .container { display: flex; gap: 20px; }
      .preview { flex: 2; }
      .preview iframe {
        width: 210mm; height: 800px; border: 1px solid #ccc;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      }
      .correction { flex: 1; max-height: 840px; overflow-y: auto; }
      .botoes { margin-top: 20px; text-align: center; }
      .botoes a,
      .botoes button {
        display: inline-block; margin: 10px; padding: 12px 20px;
        background-color: #007BFF; color: white; text-decoration: none;
        border: none; border-radius: 6px; transition: background-color 0.3s;
        cursor: pointer;
      }
      .botoes a:hover,
      .botoes button:hover { background-color: #0056b3; }
      #orcamento-frame { width: 210mm; height: 100%; border: none; 
      margin: 0 auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
    position: relative;}
  
    </style>
    <!-- Bootstrap para botÃµes e spinner -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bibliotecas para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
</head>
<body>
  
  <iframe id = "orcamento-frame" src="{{template_nome }}"></iframe>

  <button id="download-pdf" class="btn btn-primary">Baixar PDF</button>
</body>
<script>

function ajustarAlturaIframe() {
    const iframe = document.getElementById("orcamento-frame");
    if (iframe && iframe.contentWindow && iframe.contentDocument.body) {
      pixels = iframe.contentDocument.body.scrollHeight +57;
      iframe.style.height = pixels+ "px";
      console.log("Altura do iframe ajustada para: " + pixels + "px");
    }
  }

  // Ajusta ao carregar
  document.getElementById("orcamento-frame").onload = ajustarAlturaIframe;

    // PDF Download
    window.addEventListener('load', function() {
      const { jsPDF } = window.jspdf;
      document.getElementById('download-pdf').addEventListener('click', async function() {
        const btn = this;
        console.log("Gerando PDF...");
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Gerando PDF...';
        btn.disabled = true;
        try {
          const iframe = document.getElementById('orcamento-frame');
          const doc = iframe.contentDocument || iframe.contentWindow.document;
          await convertImagesToBase64(doc);
          await new Promise(r => setTimeout(r,300));
          const options = { scale:4,useCORS:true,backgroundColor:null,
            onclone:cloned=>{
              cloned.body.style.margin='0';cloned.body.style.padding='0';
              cloned.documentElement.style.margin='0 auto';
              cloned.documentElement.style.padding='0px';
              cloned.documentElement.scrollTop=0;cloned.body.scrollTop=0;
            }
          };
          const canvas = await html2canvas(doc.body, options);
          const img = canvas.toDataURL('image/png');
          const pdf = new jsPDF('p','mm','a4');
          const pw = pdf.internal.pageSize.getWidth();
          const ph = pdf.internal.pageSize.getHeight();
          const ih = (canvas.height * pw)/canvas.width;
          let heightLeft = ih, position=0;
          pdf.addImage(img,'PNG',0,position,pw,ih);
          heightLeft -= ph;
          while (heightLeft > 0) {
            position = heightLeft - ih;
            pdf.addPage();
            pdf.addImage(img,'PNG',0,position,pw,ih);
            heightLeft -= ph;
          }
          pdf.save('orcamento.pdf');
        } catch(e) { console.error('Erro:',e); alert('Erro ao gerar PDF: '+e.message); }
        finally { btn.innerHTML='Baixar PDF'; btn.disabled=false; }
      });

      async function convertImagesToBase64(document) {
        const imgs = document.querySelectorAll('img');
        await Promise.all([...imgs].map(img=>{
          if (img.src.startsWith('data:')) return Promise.resolve();
          return fetch(img.src,{mode:'cors',credentials:'include'})
            .then(res=>res.blob())
            .then(blob=>new Promise(res=>{
              const r=new FileReader();
              r.onloadend = ()=>{ img.src=r.result; res(); };
              r.readAsDataURL(blob);
            }))
            .catch(err=>console.warn('Img base64 fail',img.src,err));
        }));
      }
    });
</script>
</html>